---
import Layout from "../layouts/Layout.astro";
import { marked } from "marked";

// Import markdown content
import docContent from "../content/docs.md?raw";

type Heading = {
  level: number;
  text: string;
  id: string;
};

const slugify = (text: string): string => {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)+/g, "");
};

const getHeadings = (content: string): Heading[] => {
  const regex = /^(#+)\s+(.*)$/gm;
  const headings: Heading[] = [];
  let match;

  while ((match = regex.exec(content)) !== null) {
    const level = match[1].length;
    const text = match[2].trim();
    const id = slugify(text);

    if (level >= 2 && level <= 3) {
      headings.push({ text, level, id });
    }
  }
  return headings;
};

const headings = getHeadings(docContent);
let htmlContent: string;
try {
  htmlContent = await marked.parse(docContent);
} catch (err) {
  // If marked throws (rare), log and retry with safe options
  console.error("marked parse failed, retrying with safe options:", err);
  htmlContent = await marked.parse(docContent, { gfm: true, breaks: true });
}
---

<Layout title="Docs">
  <div class="docs-container">
    <main class="docs-main">
      <article class="docs-content" set:html={htmlContent} />
      <script is:inline>
        (function () {
          const slugify = (text) =>
            text
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, "-")
              .replace(/(^-|-$)+/g, "");
          const content = document.querySelector(".docs-content");
          if (!content) return;
          ["h2", "h3"].forEach((tag) => {
            content.querySelectorAll(tag).forEach((h) => {
              if (!h.id) h.id = slugify(h.textContent || h.innerText || "");
            });
          });
        })();
      </script>
    </main>

    <aside class="docs-sidebar">
      <div class="sidebar-sticky">
        <h4 class="sidebar-title">
          <span>â˜•</span> On this page
        </h4>
        <nav class="sidebar-nav">
          {
            headings.map((heading) => (
              <a
                href={`#${heading.id}`}
                class={heading.level === 2 ? "nav-h2" : "nav-h3"}
              >
                {heading.text}
              </a>
            ))
          }
        </nav>
      </div>
    </aside>
  </div>
</Layout>

<style>
  .docs-container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 1.5rem;
    display: flex;
    gap: 3rem;
    min-height: 100vh;
  }

  .docs-main {
    flex: 1;
    min-width: 0;
  }

  .docs-sidebar {
    width: 250px;
    flex-shrink: 0;
  }

  .sidebar-sticky {
    position: sticky;
    top: 100px;
  }

  .sidebar-title {
    font-weight: 700;
    color: var(--color-coffee-dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 1px solid var(--color-milk-dark);
    padding-bottom: 0.5rem;
  }

  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: calc(100vh - 150px);
    overflow-y: auto;
  }

  .nav-h2 {
    color: var(--color-coffee);
    font-weight: 700;
    font-size: 0.875rem;
    text-decoration: none;
  }

  .nav-h3 {
    color: var(--color-coffee-light);
    font-weight: 400;
    font-size: 0.875rem;
    padding-left: 1rem;
    text-decoration: none;
  }

  .nav-h2:hover,
  .nav-h3:hover {
    color: var(--color-coffee-dark);
  }

  @media (max-width: 1024px) {
    .docs-sidebar {
      display: none;
    }
  }

  /* Markdown content styles */
  .docs-content :global(h1) {
    font-size: 2.5rem;
    font-weight: 900;
    color: var(--color-coffee-dark);
    margin: 1.5rem 0;
    border-bottom: 2px solid var(--color-milk-dark);
    padding-bottom: 1rem;
    scroll-margin-top: 100px;
  }

  .docs-content :global(h2) {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--color-coffee-dark);
    margin: 2rem 0 1rem;
    scroll-margin-top: 100px;
  }

  .docs-content :global(h3) {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-coffee);
    margin: 1.5rem 0 1rem;
    scroll-margin-top: 100px;
  }

  .docs-content :global(h4) {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-coffee-dark);
    margin: 1rem 0 0.75rem;
  }

  .docs-content :global(h5) {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-coffee);
    margin: 1rem 0 0.5rem;
  }

  .docs-content :global(p) {
    margin-bottom: 1rem;
    color: var(--color-coffee);
    line-height: 1.8;
  }

  .docs-content :global(code) {
    background-color: var(--color-milk-cream);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: "Monaco", "Courier New", monospace;
    font-size: 0.875rem;
    border: 1px solid var(--color-milk-dark);
    color: var(--color-coffee-dark);
  }

  .docs-content :global(pre) {
    background-color: var(--color-coffee-dark);
    color: var(--color-milk);
    border-radius: 0.5rem;
    padding: 1rem;
    font-family: "Monaco", "Courier New", monospace;
    font-size: 0.875rem;
    overflow-x: auto;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    margin: 1.5rem 0;
    border: 1px solid var(--color-coffee);
  }

  .docs-content :global(pre code) {
    background: none;
    padding: 0;
    border: none;
    color: inherit;
    font-size: inherit;
  }

  .docs-content :global(a) {
    color: #2563eb;
    font-weight: 500;
    text-decoration: underline;
  }

  .docs-content :global(a:hover) {
    color: #1d4ed8;
  }

  .docs-content :global(blockquote) {
    border-left: 4px solid var(--color-coffee);
    margin: 1rem 0;
    color: var(--color-coffee-light);
    background-color: var(--color-milk-cream);
    padding: 1rem;
    border-radius: 0 0.25rem 0.25rem 0;
  }

  .docs-content :global(blockquote p) {
    margin: 0;
  }

  .docs-content :global(ul),
  .docs-content :global(ol) {
    margin-bottom: 1rem;
    margin-left: 1.5rem;
  }

  .docs-content :global(ul) {
    list-style: disc;
  }

  .docs-content :global(ol) {
    list-style: decimal;
  }

  .docs-content :global(li) {
    margin-bottom: 0.5rem;
    color: var(--color-coffee);
  }

  .docs-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    border: 1px solid var(--color-milk-dark);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .docs-content :global(thead) {
    background-color: var(--color-coffee);
    color: var(--color-milk);
  }

  .docs-content :global(th),
  .docs-content :global(td) {
    padding: 0.75rem;
    text-align: left;
    border: 1px solid var(--color-milk-dark);
  }

  .docs-content :global(tbody tr:nth-child(even)) {
    background-color: var(--color-milk-cream);
  }

  .docs-content :global(tbody tr:hover) {
    background-color: var(--color-milk-dark);
  }

  .docs-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1rem 0;
  }

  .docs-content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-milk-dark);
    margin: 2rem 0;
  }

  .docs-content :global(strong) {
    font-weight: 700;
    color: var(--color-coffee-dark);
  }

  .docs-content :global(em) {
    font-style: italic;
  }
</style>
