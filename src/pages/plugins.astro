---
import Layout from '../layouts/Layout.astro';

interface NpmPackage {
  package: {
    name: string;
    version: string;
    description: string;
    date: string;
    links: { npm: string; repository?: string };
    publisher: { username: string };
    keywords?: string[];
  };
  score: { detail: { popularity: number } };
}

// This page needs client-side interactivity, so we'll use a client component
---

<Layout title="Plugins">
  <main style="
    max-width: 56rem;
    margin: 0 auto;
    padding: 1.5rem;
  ">
    <div style="
      margin-bottom: 2rem;
      text-align: center;
    ">
      <h1 style="
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--color-coffee-dark);
        margin-bottom: 0.5rem;
      ">
        Plugin Library
      </h1>
      <p style="
        color: var(--color-coffee-light);
      ">
        Extend Milkee with community packages.
      </p>
    </div>

    <div id="plugins-container" style="
      background-color: var(--color-milk-cream);
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      border: 1px solid var(--color-milk-dark);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    ">
      <div style="display: flex; gap: 1rem; align-items: center;">
        <label style="
          font-weight: 700;
          color: var(--color-coffee);
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        ">
          Sort By:
        </label>
        <select id="sort-by" style="
          background-color: white;
          border: 1px solid var(--color-milk-dark);
          color: var(--color-coffee);
          border-radius: 0.375rem;
          padding: 0.5rem 0.75rem;
          outline: none;
        ">
          <option value="date">Recently Updated</option>
          <option value="name">Name (A-Z)</option>
          <option value="popularity">Popularity</option>
        </select>
      </div>

      <div style="display: flex; gap: 1rem; align-items: center;">
        <label style="
          font-weight: 700;
          color: var(--color-coffee);
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        ">
          Order:
        </label>
        <div style="
          display: flex;
          background-color: white;
          border-radius: 0.375rem;
          border: 1px solid var(--color-milk-dark);
          overflow: hidden;
        ">
          <button id="order-asc" style="
            padding: 0.5rem 0.75rem;
            background-color: var(--color-coffee);
            color: var(--color-milk);
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
          ">
            Asc â†‘
          </button>
          <button id="order-desc" style="
            padding: 0.5rem 0.75rem;
            color: var(--color-coffee);
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background-color: white;
          ">
            Desc â†“
          </button>
        </div>
      </div>
    </div>

    <div id="packages-list" style="
      display: grid;
      gap: 1rem;
    ">
      <p style="text-align: center; color: var(--color-coffee-light); padding: 5rem 0; animation: pulse 2s infinite;">
        Brewing list... â˜•
      </p>
    </div>
  </main>

  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>

  <script>
    interface NpmPackage {
      package: {
        name: string;
        version: string;
        description: string;
        date: string;
        links: { npm: string };
        publisher: { username: string };
      };
      score: { detail: { popularity: number } };
    }

    let allPackages: NpmPackage[] = [];
    let sortBy: 'date' | 'name' | 'popularity' = 'date';
    let order: 'asc' | 'desc' = 'desc';

    async function fetchPlugins() {
      try {
        const res = await fetch(
          'https://registry.npmjs.org/-/v1/search?text=keywords:milkee-plugin&size=100'
        );
        const data = await res.json();
        allPackages = data.objects || [];
        renderPackages();
      } catch (err) {
        console.error('Failed to fetch plugins:', err);
        const container = document.getElementById('packages-list');
        if (container) {
          container.innerHTML = '<p style="text-align: center; color: var(--color-coffee-light); padding: 2rem;">Failed to load plugins.</p>';
        }
      }
    }

    function getSortedPackages(): NpmPackage[] {
      const sorted = [...allPackages].sort((a, b) => {
        let valA: any, valB: any;
        
        if (sortBy === 'date') {
          valA = new Date(a.package.date).getTime();
          valB = new Date(b.package.date).getTime();
        } else if (sortBy === 'name') {
          valA = a.package.name;
          valB = b.package.name;
          return order === 'asc'
            ? valA.localeCompare(valB)
            : valB.localeCompare(valA);
        } else {
          valA = a.score.detail.popularity;
          valB = b.score.detail.popularity;
        }
        
        return order === 'asc' ? valA - valB : valB - valA;
      });
      
      return sorted;
    }

    function renderPackages() {
      const sorted = getSortedPackages();
      const container = document.getElementById('packages-list');
      
      if (!container) return;
      
      if (sorted.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--color-coffee-light); padding: 2rem;">No plugins found.</p>';
        return;
      }

      container.innerHTML = sorted.map((pkg) => `
        <div style="
          background-color: white;
          border: 1px solid var(--color-milk-dark);
          padding: 1.5rem;
          border-radius: 0.75rem;
          display: flex;
          flex-direction: column;
          gap: 1rem;
          transition: box-shadow 0.2s ease;
        ">
          <div>
            <div style="
              display: flex;
              align-items: baseline;
              gap: 0.75rem;
              margin-bottom: 0.25rem;
            ">
              <a href="${pkg.package.links.npm}" target="_blank" rel="noreferrer" style="
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--color-coffee);
                text-decoration: underline;
                text-decoration-color: var(--color-coffee-light);
                text-decoration-thickness: 2px;
              ">
                ${pkg.package.name}
              </a>
              <span style="
                background-color: var(--color-milk-cream);
                color: var(--color-coffee-light);
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 9999px;
                font-family: monospace;
              ">
                v${pkg.package.version}
              </span>
            </div>
            <p style="
              color: var(--color-coffee);
              margin-bottom: 0.75rem;
            ">
              ${pkg.package.description || 'No description'}
            </p>
            <div style="
              display: flex;
              flex-wrap: wrap;
              gap: 0.5rem;
              font-size: 0.875rem;
              color: var(--color-coffee-light);
            ">
              <span style="display: flex; align-items: center; gap: 0.25rem;">
                ðŸ‘¤ ${pkg.package.publisher.username}
              </span>
              <span style="display: flex; align-items: center; gap: 0.25rem;">
                ðŸ“… ${new Date(pkg.package.date).toLocaleDateString()}
              </span>
            </div>
          </div>

          <a href="${pkg.package.links.npm}" target="_blank" rel="noreferrer" style="
            padding: 0.5rem 1rem;
            background-color: var(--color-coffee);
            color: var(--color-milk);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            transition: background-color 0.2s ease;
            text-align: center;
            display: inline-block;
            width: fit-content;
          " onmouseover="this.style.backgroundColor='var(--color-coffee-light)'" onmouseout="this.style.backgroundColor='var(--color-coffee)'">
            View on npm
          </a>
        </div>
      `).join('');
    }

    // Event listeners
    document.getElementById('sort-by')?.addEventListener('change', (e) => {
      sortBy = (e.target as HTMLSelectElement).value as 'date' | 'name' | 'popularity';
      renderPackages();
    });

    document.getElementById('order-asc')?.addEventListener('click', () => {
      order = 'asc';
      updateOrderButtons();
      renderPackages();
    });

    document.getElementById('order-desc')?.addEventListener('click', () => {
      order = 'desc';
      updateOrderButtons();
      renderPackages();
    });

    function updateOrderButtons() {
      const ascBtn = document.getElementById('order-asc');
      const descBtn = document.getElementById('order-desc');
      
      if (order === 'asc') {
        ascBtn!.style.backgroundColor = 'var(--color-coffee)';
        ascBtn!.style.color = 'var(--color-milk)';
        descBtn!.style.backgroundColor = 'white';
        descBtn!.style.color = 'var(--color-coffee)';
      } else {
        ascBtn!.style.backgroundColor = 'white';
        ascBtn!.style.color = 'var(--color-coffee)';
        descBtn!.style.backgroundColor = 'var(--color-coffee)';
        descBtn!.style.color = 'var(--color-milk)';
      }
    }

    // Initialize
    fetchPlugins();
  </script>
</Layout>
